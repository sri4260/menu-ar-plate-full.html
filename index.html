<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Markerless AR Menu - Place Food on Table</title>

<style>
  body,html { margin:0; padding:0; height:100%; font-family:system-ui,Arial; overflow:hidden; }
  #ui {
    position:fixed;
    top:10px;
    left:10px;
    background:rgba(255,255,255,0.95);
    border-radius:10px;
    padding:12px;
    z-index:999;
    width:260px;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
  }
  h2 { margin:0 0 8px 0; font-size:18px; color:#0b74de; }
  .itemCard {
    border:1px solid #ddd; border-radius:8px;
    padding:6px; margin-bottom:8px;
    cursor:pointer;
  }
  .itemCard img { width:100%; height:90px; object-fit:cover; border-radius:6px; }
  .itemCard:hover { background:#f0f6ff; }
  button {
    padding:8px 10px; background:#0b74de; color:#fff; border:none; border-radius:6px;
    cursor:pointer; width:100%; margin-top:5px;
  }
  #message { font-size:13px; color:#333; margin-top:6px; }
  canvas { width:100%; height:100%; display:block; }
</style>
</head>
<body>
  <div id="ui">
    <h2>üçï AR Food Menu</h2>
    <div id="menuList"></div>
    <div id="message">Status: waiting...</div>
  </div>

  <!-- three.js + ARButton for WebXR -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js"></script>

<script>
(async function(){

// -------------------- MENU DATA --------------------
const MENU = [
  { id: "PIZZA01", name: "Margherita Pizza", price: "‚Çπ299", img: "https://ooni.com/cdn/shop/articles/20220211142347-margherita-9920_ba86be55-674e-4f35-8094-2067ab41a671.jpg?v=1737104576&width=1080" },
  { id: "BURGER01", name: "Veg Burger", price: "‚Çπ149", img: "https://i.imgur.com/7kQEs5G.jpg" },
  { id: "PANEER01", name: "Paneer Butter Masala", price: "‚Çπ229", img: "https://i.imgur.com/Xn0yqKw.jpg" },
];
let selectedItem = MENU[0];

// -------------------- UI SETUP --------------------
const menuList = document.getElementById("menuList");
const message = document.getElementById("message");

function renderMenu(){
  menuList.innerHTML = "";
  MENU.forEach(item=>{
    const div = document.createElement("div");
    div.className = "itemCard";
    div.innerHTML = `
      <img src="${item.img}" alt="${item.name}">
      <div><strong>${item.name}</strong><br>${item.price}</div>
      <button>Select</button>
    `;
    div.querySelector("button").addEventListener("click",()=>{
      selectedItem = item;
      message.textContent = `Selected: ${item.name}`;
    });
    menuList.appendChild(div);
  });

  const startBtn = document.createElement("button");
  startBtn.textContent = "Enter AR Mode";
  startBtn.addEventListener("click",()=>initAR());
  menuList.appendChild(startBtn);
}
renderMenu();

// -------------------- WEBXR / THREE.JS AR SETUP --------------------
let scene, camera, renderer, reticle, hitTestSource=null, xrRefSpace=null;
const placed = [];

async function initAR(){
  if(!navigator.xr){
    message.textContent = "WebXR not supported in this browser. Use Chrome on Android.";
    return;
  }

  const supported = await navigator.xr.isSessionSupported("immersive-ar");
  if(!supported){
    message.textContent = "AR not supported on this device.";
    return;
  }

  message.textContent = "Starting AR... please wait.";

  // setup renderer
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();
  renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  renderer.setPixelRatio(window.devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  // create ring reticle
  reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.07, 0.09, 32).rotateX(-Math.PI/2),
    new THREE.MeshBasicMaterial({ color:0x00ffff, opacity:0.8, transparent:true })
  );
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // request AR session
  const session = await navigator.xr.requestSession("immersive-ar", {
    requiredFeatures: ["hit-test","dom-overlay"],
    domOverlay: { root: document.body }
  });
  session.addEventListener("end", ()=>{ message.textContent="AR session ended."; });
  renderer.xr.setSession(session);

  xrRefSpace = await session.requestReferenceSpace("local");
  const viewerSpace = await session.requestReferenceSpace("viewer");
  hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

  // handle tap event
  renderer.domElement.addEventListener("click",()=>onTap());

  // AR render loop
  renderer.setAnimationLoop((time, frame)=>{
    if(frame){
      const hitResults = frame.getHitTestResults(hitTestSource);
      if(hitResults.length>0){
        const pose = hitResults[0].getPose(xrRefSpace);
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);
      } else {
        reticle.visible = false;
      }
    }
    renderer.render(scene, camera);
  });

  message.textContent = "AR started! Move phone to detect table, tap to place food.";
}

// -------------------- PLACE FOOD IMAGE --------------------
async function onTap(){
  if(!reticle.visible){
    message.textContent = "No surface detected. Move phone slowly.";
    return;
  }

  try {
    const tex = await new THREE.TextureLoader().loadAsync(selectedItem.img);
    const aspect = tex.image.width / tex.image.height;
    const width = 0.2; // 20cm wide
    const height = width / aspect;

    const geo = new THREE.PlaneGeometry(width, height);
    const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
    const mesh = new THREE.Mesh(geo, mat);

    mesh.applyMatrix4(reticle.matrix);
    mesh.rotateX(-Math.PI/2); // make it flat
    scene.add(mesh);
    placed.push(mesh);

    message.textContent = `Placed: ${selectedItem.name}. Tap again to add more.`;
  } catch(err){
    console.error(err);
    message.textContent = "Failed to load image.";
  }
}

})();
</script>
</body>
</html>

